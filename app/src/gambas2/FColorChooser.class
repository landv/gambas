' Gambas class file

STATIC PUBLIC Color AS String
STATIC PUBLIC Value AS Integer

STATIC PRIVATE $sColor AS String
STATIC PRIVATE $aSystem AS String[] = ["Background", "Foreground", "SelectedBackground", "SelectedForeground", "LightBackground", "TextBackground", "TextForeground", "ButtonBackground", "ButtonForeground"]

PRIVATE CONST DEFAULT_COLOR AS String = "-"

PRIVATE $cColor AS NEW Collection

STATIC PUBLIC FUNCTION Run(OPTIONAL sColor AS String) AS Boolean

  $sColor = sColor
  'IF NOT $sColor THEN $sColor = Color
  'IF NOT $sColor THEN $sColor = "&H" & Hex$(Value, 6)
  IF FColorChooser.ShowModal() THEN
    Color = $sColor
    IF $sColor THEN
      TRY Value = Val($sColor)
      IF ERROR THEN 
        Value = Object.GetProperty(Classes["Color"], $sColor)
      ELSE 
        Color = "&H" & Hex$(Value, 6) & "&"
      ENDIF
    ELSE
      Value = -1
    ENDIF
    'DEBUG Value;; "'"; Color; "'"
  ELSE
    RETURN TRUE
  ENDIF

END


PRIVATE SUB AddColor(sText AS String, sTag AS String, sColor AS String)

  DIM hBox AS HBox
  DIM hLabel AS Label
  DIM hColor AS Label
  DIM hPict AS PictureBox

  hBox = NEW HBox(lstSystem)
  hBox.Padding = 4
  hBox.Spacing = 4
  hBox.Height = 24
  hBox.Tag = sTag

  IF sColor = DEFAULT_COLOR THEN
    hPict = NEW PictureBox(hBox)
    'hPict.Border = Border.Plain
    hPict.Picture = Picture["img/16/tile.png"]
    hPict.Resize(16, 16)
    hPict.Design = TRUE
  ELSE
    hColor = NEW Label(hBox)
    hColor.Background = Object.GetProperty(Classes["Color"], sColor)
    hColor.Border = Border.Plain
    hColor.Resize(16, 16)
    hColor.Design = TRUE
  ENDIF

  hLabel = NEW Label(hBox)
  hLabel.Expand = TRUE
  hLabel.Text = sText
  hLabel.Design = TRUE

  $cColor[sColor] = hBox

END

PUBLIC SUB btnOK_Click()

  IF tabColor.Index = 1 THEN
    $sColor = dlgColor.SelectedColor
  ELSE
    TRY $sColor = lstSystem.Current.Tag
  ENDIF
  ME.Close(TRUE)

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB Form_Open()

  DIM sSystem AS String

  Settings.Read(ME)

  AddColor("Default", "", DEFAULT_COLOR)
  FOR EACH sSystem IN $aSystem
    AddColor(sSystem, sSystem, sSystem)
  NEXT

  IF NOT IsNull(Val($sColor)) THEN
    dlgColor.SelectedColor = Val($sColor)
    tabColor.Index = 1
  ELSE
    IF $sColor THEN
      lstSystem.Select($cColor[$sColor])
    ELSE
      lstSystem.Select($cColor[DEFAULT_COLOR])
    ENDIF
    tabColor.Index = 0
  ENDIF

END

PUBLIC SUB dlgColor_Activate()

  btnOK.Value = TRUE

END


PUBLIC SUB lstSystem_Activate()

  btnOK.Value = TRUE

END


PUBLIC SUB Form_Close()

  Settings.Write(ME)  

END
