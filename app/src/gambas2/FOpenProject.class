' Gambas class file

STATIC PRIVATE $sPath AS String
STATIC PRIVATE $sLast AS String
STATIC PRIVATE $bAnother AS Boolean

STATIC PUBLIC InAnotherWindow AS Boolean

PRIVATE frmProjectItem AS FProjectItem

PUBLIC SUB Run(OPTIONAL bAnother AS Boolean) AS String

  $bAnother = bAnother
  IF ME.ShowModal() THEN RETURN $sPath

END

PUBLIC SUB _new()
  
  frmProjectItem = NEW FProjectItem(panProject)
  
END


PUBLIC SUB btnOK_Click()

  DIM sPath AS String
  
  IF tabProject.Index = 0 THEN
    sPath = GetProjectPath(dchProject.Value)
  ELSE IF tabProject.Index = 1 THEN
    TRY sPath = lstRecent.Current.Tag
  ELSE IF tabProject.Index = 2 THEN
    TRY sPath = lstExample.Current.Tag
  ENDIF

  IF NOT sPath THEN RETURN

  $sPath = sPath
  'Settings["/FOpenProject/Path"] = $sPath
  'tabProject.Index = 0
  lstRecent.Clear
  InAnotherWindow = chkOther.Value  
  
  ME.Close(TRUE)

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END


PUBLIC SUB Form_Open()

  $sLast = ""
  Settings.Read(ME)
  Settings.Read(dchProject)
  Settings.Read(splProject)
  'dchProject.Value = Settings["/FOpenProject/Path"]
  dchProject_Change
  tabProject_Click

  chkOther.Value = FALSE
  InAnotherWindow = FALSE
  chkOther.Visible = $bAnother
  chkSortRecent.Value = Settings["/FOpenProjet/SortRecent", FALSE]  

END

PUBLIC SUB Form_Close()

  Settings.Write(ME)  
  Settings.Write(splProject)
  Settings.Write(dchProject)
  Settings["/FOpenProject/SortRecent"] = chkSortRecent.Value
  
END

PUBLIC SUB dchProject_Icon(Path AS String)

  IF Exist(Path &/ ".project") THEN 
    dchProject.Icon = Project.GetIcon(Path)    
  ENDIF  

END

PRIVATE SUB GetProjectPath(sPath AS String) AS String
  
  DO
    IF Exist(sPath &/ ".project") THEN RETURN sPath
    sPath = File.Dir(sPath)
    IF sPath = "/" THEN BREAK
  LOOP
  
CATCH
  
END


PUBLIC SUB dchProject_Change()

  DIM sPath AS String
  
  fvwProject.ShowHidden = dchProject.ShowHidden  
  fvwProject.Dir = dchProject.Value

  sPath = GetProjectPath(dchProject.Value)
  
  IF NOT sPath THEN
    $sLast = ""
    sdpProject.Hide
    RETURN 
  ENDIF
  
  IF sPath = $sLast THEN RETURN
  
  $sLast = sPath
  
  frmProjectItem.SetPath(sPath)
  
  sdpProject.Show

END

PUBLIC SUB fvwProject_Activate()

  dchProject.Value = fvwProject.Dir &/ fvwProject.Current

END

PUBLIC SUB fvwProject_Icon(Path AS String)

  IF Exist(Path &/ ".project") THEN 
    fvwProject.Icon = Project.GetIcon(Path, 16)    
  ENDIF    

END

PRIVATE SUB FillRecent()
  
  DIM sRecent AS String
  DIM hProjectItem AS FProjectItem
  DIM hFirst AS FProjectItem
  DIM aRecent AS String[]
  DIM bHighlight AS Boolean
  
  IF lstRecent.Children.Count THEN RETURN

  INC Application.Busy

  panRecent.Arrangement = Arrange.None
  lstRecent.Hide

  aRecent = Project.GetRecentFiles(chkSortRecent.Value)

  FOR EACH sRecent IN aRecent
    hProjectItem = NEW FProjectItem(lstRecent)
    IF bHighlight THEN hProjectItem.Background = Color.LightBackground
    bHighlight = NOT bHighlight
    IF NOT hFirst THEN hFirst = hProjectItem
    hProjectItem.SetPath(sRecent)
  NEXT
  
  IF hFirst THEN lstRecent.Select(hFirst)
  
  ' Workaround a scrollview bug that does not show the scrollbars.
  lstRecent.Show 
  panRecent.Arrangement = Arrange.Vertical
  
  DEC Application.Busy
  
END

PUBLIC SUB tabProject_Click()

  IF tabProject.Index = 1 THEN 
    FillRecent
  ELSE IF tabProject.Index = 2 THEN 
    FillExample
  ENDIF  

END

PUBLIC SUB lstRecent_Activate()
  
  btnOK.Value = TRUE
  
END

PRIVATE SUB FillExample()

  DIM sExample AS String
  DIM sDir AS String
  DIM sLastDir AS String
  DIM hDrawingArea AS DrawingArea
  DIM hProjectItem AS FProjectItem
  DIM hLabel AS Label
  DIM bHighlight AS Boolean
  
  IF lstExample.Children.Count THEN RETURN

  INC Application.Busy

  FOR EACH sExample IN Project.GetExamples()
  
    sDir = File.Dir(sExample)
    IF sDir <> sLastDir THEN
      hDrawingArea = NEW DrawingArea(lstExample) AS "dwgExample"
      WITH hDrawingArea
        .Enabled = FALSE
        .Tag = Project.ExampleTitle[sDir]
        .Font = Font["Bold,+2"]
        .H = .Font.Height() + If(sLastDir, 16, 8)
        .Foreground = Color.SelectedBackground
      END WITH
      bHighlight = FALSE
      sLastDir = sDir
    ENDIF
    
    hProjectItem = NEW FProjectItem(lstExample)
    IF bHighlight THEN hProjectItem.Background = Color.LightBackground
    bHighlight = NOT bHighlight
    hProjectItem.SetPath(Project.EXAMPLES_DIR &/ sExample)
  
  NEXT

  lstExample.Show ' Workaround a scrollview bug that does not show the scrollbars.

  DEC Application.Busy

END

PUBLIC SUB dwgExample_Draw()
  
  DIM hDrawingArea AS DrawingArea = LAST
  
  WITH hDrawingArea
    Draw.Font = .Font
    Draw.Foreground = .Foreground
    'Draw.Line(0, .H / 2 - 1, .W - 1, .H / 2 - 1)
    'Draw.Transparent = FALSE
    Draw.Text(.Tag, 4, 0, .W - 16, .H - 4, Align.BottomNormal)
    Draw.Line(4, .H - 4, .W - 9, .H - 4)
  END WITH
  
END

PUBLIC SUB dchProject_Activate()

  btnOK.Value = TRUE  

END


PUBLIC SUB chkSortRecent_Click()

  IF tabProject.Index = 1 THEN 
    lstRecent.Clear
    FillRecent
  ENDIF

END

PUBLIC SUB OnUpdateRecent()
  
  lstRecent.Clear
  chkSortRecent_Click
  
END


PUBLIC SUB lstExample_Activate()

  btnOK.Value = TRUE

END
