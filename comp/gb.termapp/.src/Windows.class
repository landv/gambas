' Gambas class file

Create Static

Class Rect

Static Private $aAreas As New Integer[][]
Static Private $iScrWidth As Integer
Static Private $iScrHeight As Integer

Static Private $aWindows As New Window[]
Static Private $hScreenRect As New Rect
Static Private $aRefreshArea As New Rect
Static Private $bNeedRefreshArea As Boolean
Static Private $hRenderArea As New Rect
Static Private $hObs As Observer
Static $hFile As File
Static hTimer As New Timer As "Tim"

Static Public Sub _init()

  Dim i As Integer
  Dim hAreaLine As Integer[]
  
  Component.Load("gb.geom")
  
  
  File.Out.Term.Echo = False
  Print "\e[?1002h\e[?1006h\e[?1049h\e[?25l\e[?2h";
  
  'hTimer.Delay = 500
  'hTimer.Start
  
  Application_Resize
  
  File.In.Term.FlowControl = False
  $hObs = New Observer(File.In) As "Application"
  $hFile = Open File.In.Term.Name For Read Watch
  
  $hScreenRect = Rect(0, 0, File.Out.Term.Width, File.Out.Term.Height)
  
  _RefreshAreas($hScreenRect)
  
End

Public Sub _Add(hWin As Window)
  
  $aWindows.Add(hWin)
  Print hWin.Tag
  
End

Static Public Sub _RefreshAreas(hRect As Rect)
  
  $aRefreshArea = $aRefreshArea.Union(hRect)
  $hRenderArea = $hRenderArea.Union(hRect)
  $bNeedRefreshArea = True
  
End




Static Private Sub DoRefreshAreas()
  Dim hChild As Control
  Dim hInRect As Rect
  
  If Not $bNeedRefreshArea Then Return
  
  For Each hChild In $aWindows
    If hChild.Visible = False Then Continue
    'C'est la zone visible de la fenÃªtre si visible
    hInRect = $hScreenRect.Intersection($aRefreshArea)
    If Not hInRect Then Continue
    RefreshChild(hChild, hInRect)
  Next
  
  $bNeedRefreshArea = False
  $aRefreshArea = New Rect
End

Static Private Sub RefreshChild(hChild As Object, hRect As Rect)

  
  Dim iLeft, iRight, iTop, iBottom As Integer
 
  Dim L As Integer
  Dim C As Integer
  Dim hObj As Object
  Dim hInRect As Rect
  
  hInRect = hRect.Intersection(hChild._GetScreenRect())
  
  If Not hInRect Then Return

 
  For L = hInRect.Top To hInRect.Bottom - 1
    
    For C = hInRect.Left To hInRect.Right - 1
      $aAreas[L][C] = hChild.Id
    Next
  Next
  
  If hChild Is Container Then
    
    For Each hObj In hChild.children
      RefreshChild(hObj, hRect)
    Next
    
  Endif
  
End

Static Public Sub Render()
  
   Dim a As Integer[]
   Dim i As Integer
  ' ' 
  Dim hCont As Control
  Dim iRow As Integer
  Dim iCol As Integer
  Dim hAttr As New Attr
  Dim hLine As CLine
  Dim aAttr As Integer[]
  Dim hCAttr As Attr
  Dim cCol As Integer
   DoRefreshAreas()
  $hRenderArea = $hScreenRect.Intersection($hRenderArea)
  For iRow = $hRenderArea.Top To $hRenderArea.Bottom - 1
    Print "\e[" & iRow & ";0H";
    For iCol = $hRenderArea.Left To $hRenderArea.Right - 1
      If $aAreas[iRow][iCol] = 0 Then
        hAttr.Background = Color.yellow
        hAttr.Send
        Print " ";
      Else
  
        i = $aAreas[iRow][iCol]
        hCont = Control._IdToControl[i]
        hLine = hCont._Content[iRow - hCont.ScreenY]
        aAttr = hLine.GetAttr()
        cCol = iCol - hCont.ScreenX
        Try hAttr.FillFrom(aAttr[Min(aAttr.Max, cCol)])
        
        hAttr.Send
        If cCol < hLine.Length Then
          Print Mid(hLine.Text, cCol + 1, 1);
        Else
          hAttr.Background = hCont.Background
          hAttr.Send
          Print " ";
        Endif
        
        
        
        
        
      Endif
    Next
  Next
  
  
  
  Catch
  ' For Each a In $aAreas
  '   For i = 0 To a.Max
  '     Print a[i];
  '   Next
  '   Print
  ' Next
End


Static Public Sub File_Read()
  
  Dim iByte As Byte
  Dim s As String
  s = Read #$hFile, Lof($hFile)
  'Read #$hFile, iByte
  Print Quote("s= " & s)
  'If s <> "" Then Stop
  'Quit
End


Static Public Sub Application_Resize()
  Dim i As Integer
  Dim hAreaLine As New Integer[]
  $hScreenRect.Width = File.Out.Term.Width
  $hScreenRect.Height = File.Out.Term.Height
  
  $aAreas = New Integer[][]
  
  For i = 0 To $hScreenRect.Height
    
    hAreaLine = New Integer[$hScreenRect.Width]
    $aAreas.Add(hAreaLine)
  Next
  
  _RefreshAreas($hScreenRect)
  Render
End

Static Public Sub Tim_Timer()
  
  File_Read
  
End

Static Public Sub _RefreshAll()
  
  _RefreshAreas($hScreenRect)
  Render
  
End


