' Gambas class file

Private hWebcam As VideoDevice
Private OnSet As Boolean
Private Fps As Date
Private nFps As Integer

Public Sub Button1_Click()


  Dim num As Integer
  Dim Buf As String

  If hWebCam Then
    Button1.Caption = ("Capture")
    Bright.Enabled = False
    Contrast.Enabled = False
    Hue.Enabled = False
    Whiteness.Enabled = False
    Colour.Enabled = False
    V1.Enabled = False
    V2.Enabled = False
    V3.Enabled = False
    V4.Enabled = False
    V5.Enabled = False
    V6.Enabled = False
    FreqUp.Enabled = False
    FreqDown.Enabled = False
    TxtDevice.Enabled = True
    BtnTakeShot.Enabled = False
    Button2.Enabled = False
    hWebCam = Null
    Tmr.Enabled = False
    Return
  End If


  Try hWebCam = New VideoDevice(TxtDevice.Text)
  If Error Then
    Message.Error(("Unable to open video device"))
    Return
  End If
  hWebCam.Source = hWebCam.TV + hWebCam.PAL

  Button1.Caption = ("Stop")
  BtnTakeShot.Enabled = True
  Button2.Enabled = True
  Bright.Enabled = True
  Contrast.Enabled = True
  Hue.Enabled = True
  Whiteness.Enabled = True
  Colour.Enabled = True
  V1.Enabled = True
  V2.Enabled = True
  V3.Enabled = True
  V4.Enabled = True
  V5.Enabled = True
  V6.Enabled = True
  FreqUp.Enabled = True
  FreqDown.Enabled = True
  TxtDevice.Enabled = False
  OnSet = True
  Bright.Value = hWebcam.Bright
  Contrast.Value = hWebcam.Contrast
  Hue.Value = hWebCam.Hue
  Whiteness.Value = hWebCam.Whiteness
  Colour.Value = hWebCam.Color
  LblFreq.Text = "Tuner frequency: " & hWebCam.Tuner.Frequency

  Wait 0.001
  OnSet = False
  Tmr.Delay = 10
  Tmr.Enabled = True
  Me.Caption = hWebCam.Name
  Fps = Now()
  nFps = 0


End





Public Sub Bright_Change()

  If OnSet Then Return
  hWebCam.Bright = Bright.Value

End

Public Sub Contrast_Change()

  If OnSet Then Return
  hWebCam.Contrast = Contrast.Value

End

Public Sub Whiteness_Change()

  If OnSet Then Return
  hWebCam.Whiteness = Whiteness.Value

End

Public Sub Colour_Change()

  If OnSet Then Return
  hWebcam.Color = Colour.Value

End

Public Sub Hue_Change()

  If OnSet Then Return
  hWebCam.Hue = Hue.Value

End

Public Sub V1_Click()

  If V1.Value Then hWebCam.Resize(128, 96)

End

Public Sub V2_Click()

  If V2.Value Then hWebCam.Resize(160, 120)

End

Public Sub V3_Click()

    If V3.Value Then hWebCam.Resize(176, 144)

End

Public Sub V4_Click()

    If V4.Value Then hWebCam.Resize(320, 240)

End

Public Sub V5_Click()

    If V5.Value Then hWebCam.Resize(356, 288)

End

Public Sub V6_Click()

    If V6.Value Then hWebCam.Resize(640, 480)

End

Public Sub Tmr_Timer()

  Dim T1 As Date
  Dim sBuf As String
  Dim hPict As Picture

  Tmr.Enabled = False

  'Try PictureBox1.Picture = hWebCam.Picture
  Draw.Begin(dwgVideo)
  hPict = hWebCam.Image.Picture
  Draw.Picture(hPict, (dwgVideo.W - hPict.W) \ 2, (dwgVideo.H - hPict.H) \ 2)
  Draw.End
  
  If Not Error Then
    nFps = nFps + 1
    T1 = Now() - Fps
    If Second(T1) >= 1 Then
      Me.Caption = hWebCam.Name & " (" & nFps & " fps)"
      Fps = Now()
      nFps = 0
    End If
  End If
  Tmr.Enabled = True

End


Public Sub Form_Close()

  Tmr.Enabled = False
  hWebCam = Null

End





Public Sub FreqUP_Click()

  hWebCam.Tuner.Frequency = hWebCam.Tuner.Frequency + 5
  LblFreq.Text = "Tuner frequency: " & hWebCam.Tuner.Frequency

End



Public Sub FreqDown_Click()

  hWebCam.Tuner.Frequency = hWebCam.Tuner.Frequency - 5
  LblFreq.Text = "Tuner frequency: " & hWebCam.Tuner.Frequency

End

Public Sub Button2_Click()

  Dim sCad As String

  sCad = "Device Bus: " & hWebCam.Bus & "\n"
  sCad = sCad & "Device Driver: " & hWebCam.Driver & " Version: " & hWebCam.Version & "\n"
  sCad = sCad & "Device Name: " & hWebCam.Name & "\n"
  sCad = sCad & "Max.Resolution: " & hWebCam.MaxWidth & "x" & hWebCam.MaxHeight & "\n"
  sCad = sCad & "Min. Resolution: " & hWebCam.MinWidth & "x" & hWebCam.MinHeight & "\n"

  Message.Info(sCad)

End

Public Sub BtnTakeShot_Click()

  Try hWebCam.Save(User.Home & "/webcam_shot.png")
  If Not Error Then Message.Info("Image saved as " & User.Home & "/webcam_shot.png")
End

Public Sub Panel2_MouseDown()



End
