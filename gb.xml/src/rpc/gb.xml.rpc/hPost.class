' Gambas class file

PUBLIC Http AS HttpClient
PRIVATE Buffer AS String
PUBLIC Mode AS Boolean

EVENT GotData(Data AS String)

EVENT GotError()

PUBLIC SUB Http_Read()

  DIM sCad AS String

  IF Mode = FALSE THEN RETURN

  IF Lof(Http) THEN
    TRY READ #Http, sCad, Lof(Http)
    IF Not ERROR THEN Buffer = Buffer & sCad
  END IF

END

PUBLIC SUB Http_Finished()

  DIM sCad AS String

  IF Mode = FALSE THEN RETURN

  IF Lof(Http) THEN
    TRY READ #Http, sCad, Lof(Http)
    IF Not ERROR THEN Buffer = Buffer & sCad
  END IF

  RAISE GotData(Buffer)


END

PUBLIC SUB Http_Error()

  IF Mode = FALSE THEN RETURN

  TRY CLOSE #Http

  RAISE GotError()

END



PUBLIC FUNCTION PostData(Data AS String) AS String

  DIM sCad AS String

  Buffer = ""
  sCad = ""
  Http.Post("text/xml", Data)

  IF Mode = FALSE THEN
    DO WHILE Http.Status > 0

      WAIT 0.001

    LOOP

    IF Http.Status < 0 THEN RETURN ""
    IF Http.Code <> 200 THEN RETURN ""

    IF Lof(Http) THEN

      READ #Http, sCad, Lof(Http)

    END IF

    sCad = Trim(sCad)
    RETURN sCad

  END IF

END


PUBLIC SUB _new(sUrl AS String)

  Http = NEW HttpClient AS "Http"

  Http.URL = sUrl

END
